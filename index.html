<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elephant Detection System</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    h1 { margin-bottom: 20px; }
    #canvas { margin-top: 20px; border: 3px solid #222; max-width: 90%; }
    #upload { margin: 20px; }
    #count { font-size: 20px; margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>üêò Elephant Detection System</h1>
  <input type="file" id="upload" accept="image/*">
  <div id="count">Please upload an image...</div>
  <canvas id="canvas"></canvas>

  <script>
    let model;

    async function loadModel() {
      model = await tf.loadGraphModel("./tfjs_model/model.json"); // path to your model
      console.log("‚úÖ Model loaded");
    }

    async function detect(imgElement) {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = imgElement.width;
      canvas.height = imgElement.height;
      ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);

      const input = tf.tidy(() =>
        tf.browser.fromPixels(imgElement)
          .resizeBilinear([640, 640])
          .expandDims(0)
          .toFloat()
          .div(255)
      );

      const output = await model.executeAsync(input);
      const raw = output.arraySync()[0]; // shape [5, 8400]
      input.dispose();
      output.dispose();

      const reshaped = tf.transpose(tf.tensor(raw), [1, 0]).arraySync();
      const boxes = [];
      reshaped.forEach(d => {
        const [x, y, w, h, conf] = d;
        if (conf > 0.5) {
          const x1 = (x - w/2) * canvas.width;
          const y1 = (y - h/2) * canvas.height;
          const x2 = (x + w/2) * canvas.width;
          const y2 = (y + h/2) * canvas.height;
          boxes.push([x1, y1, x2, y2, conf]);
        }
      });

      if (boxes.length === 0) {
        document.getElementById("count").innerText = "‚ùå No elephants detected.";
        return;
      }

      const boxesTensor = tf.tensor2d(boxes.map(b => [b[0], b[1], b[2], b[3]]));
      const scoresTensor = tf.tensor1d(boxes.map(b => b[4]));
      const nmsIndices = await tf.image.nonMaxSuppressionAsync(boxesTensor, scoresTensor, 50, 0.5, 0.5);
      const selected = await nmsIndices.array();
      boxesTensor.dispose();
      scoresTensor.dispose();
      nmsIndices.dispose();

      ctx.lineWidth = 3;
      ctx.font = "18px Arial";
      ctx.strokeStyle = "lime";
      ctx.fillStyle = "lime";

      selected.forEach(i => {
        const [x1, y1, x2, y2, conf] = boxes[i];
        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
        ctx.fillText("Elephant " + (conf*100).toFixed(1) + "%", x1, y1 > 20 ? y1 - 5 : 20);
      });

      document.getElementById("count").innerText = "‚úÖ Elephants detected: " + selected.length;
    }

    document.getElementById("upload").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => detect(img);
      img.src = URL.createObjectURL(file);
    });

    loadModel();
  </script>
</body>
</html>
