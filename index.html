<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elephant Detector</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
    h1 { margin: 1rem 0; }
    #uploadSection, #mapSection { margin: 1rem 0; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; width: 90%; max-width: 900px; }
    canvas { border: 1px solid #ccc; margin-top: 1rem; }
    #map { width: 100%; height: 500px; margin-top: 1rem; }
    .bar { height: 6px; background: #4ade80; width: 0%; transition: width 0.4s; margin-top: 6px; }
    .pill { background: #222; color: #fff; padding: 2px 6px; border-radius: 6px; font-size: 0.8rem; margin-left: 5px; }
    ul { padding: 0; list-style: none; }
  </style>
</head>
<body>
  <h1>Elephant Detector</h1>

  <div id="uploadSection">
    <h2>Upload Image</h2>
    <input type="file" id="fileInput" accept="image/*">
    <div class="bar" id="imgBar"></div>
    <p id="imgStatus"></p>
    <p id="imgCount"></p>
    <canvas id="imgCanvas"></canvas>
    <ul id="imgList"></ul>
  </div>

  <div id="mapSection">
    <h2>Analyze Map</h2>
    <button id="analyzeMap">Analyze Current Map View</button>
    <div class="bar" id="mapBar"></div>
    <p id="mapStatus"></p>
    <p id="mapCount"></p>
    <div id="map"></div>
    <ul id="mapList"></ul>
  </div>

<script>
let model;
async function loadModel() {
  model = await tf.loadGraphModel("./tfjs_model/model.json");
}
loadModel();

function preprocess(imgEl) {
  return tf.tidy(() => {
    let t = tf.browser.fromPixels(imgEl).toFloat();
    t = tf.image.resizeBilinear(t, [640, 640]);
    t = t.expandDims(0);
    return t.div(255);
  });
}

async function runModelOnImageEl(imgEl) {
  const input = preprocess(imgEl);
  const res = await model.executeAsync(input);
  const arr = await res.array();
  tf.dispose(res); tf.dispose(input);
  const dets = arr[0];
  const boxes = [];
  for (let i = 0; i < dets.length; i++) {
    const [x,y,w,h,conf] = dets[i];
    if (conf > 0.5) {
      boxes.push({x,y,w,h,conf});
    }
  }
  return boxes;
}

const fileInput = document.getElementById("fileInput");
const imgCanvas = document.getElementById("imgCanvas");
const imgCtx = imgCanvas.getContext("2d");
const imgStatus = document.getElementById("imgStatus");
const imgCount = document.getElementById("imgCount");
const imgList = document.getElementById("imgList");
const imgBar = document.getElementById("imgBar");

fileInput.onchange = async e => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.src = url;
  img.onload = async () => {
    imgCanvas.width = img.width;
    imgCanvas.height = img.height;
    imgCtx.drawImage(img,0,0,img.width,img.height);
    imgStatus.textContent = "Analyzing…"; imgBar.style.width="50%";
    const boxes = await runModelOnImageEl(img);
    imgCtx.strokeStyle = "#22c55e";
    imgCtx.lineWidth = 3;
    imgList.innerHTML="";
    boxes.forEach((b,i)=>{
      imgCtx.strokeRect(b.x,b.y,b.w,b.h);
      const li=document.createElement("li");
      li.textContent = `#${i+1} Elephant ${(b.conf*100).toFixed(1)}%`;
      imgList.appendChild(li);
    });
    imgCount.textContent="Elephants detected: "+boxes.length;
    imgStatus.textContent="Done"; imgBar.style.width="100%";
    setTimeout(()=>imgBar.style.width="0%",800);
  }
};

const map = L.map("map").setView([0,0],2);
L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
  maxZoom: 19,
  attribution: "© Esri World Imagery"
}).addTo(map);
const rectLayerGroup=L.layerGroup().addTo(map);
const analyzeMap=document.getElementById("analyzeMap");
const mapStatus=document.getElementById("mapStatus");
const mapCount=document.getElementById("mapCount");
const mapList=document.getElementById("mapList");
const mapBar=document.getElementById("mapBar");

async function detectMapView() {
  if(!model){mapStatus.textContent="Model not ready";return;}
  analyzeMap.disabled=true; mapStatus.textContent="Rendering view…"; mapBar.style.width="20%";
  leafletImage(map, async (err,canvas)=>{
    if(err){mapStatus.textContent="Render failed"; analyzeMap.disabled=false; return;}
    mapStatus.textContent="Analyzing…"; mapBar.style.width="50%";
    const boxes=await runModelOnImageEl(canvas);
    rectLayerGroup.clearLayers(); mapList.innerHTML="";
    boxes.forEach((b,i)=>{
      const p1=L.point(b.x,b.y), p2=L.point(b.x+b.w,b.y+b.h);
      const ll1=map.containerPointToLatLng(p1), ll2=map.containerPointToLatLng(p2);
      const rect=L.rectangle([ll1,ll2],{color:"#22c55e",weight:2,fillOpacity:0.05});
      rect.addTo(rectLayerGroup);
      const center=rect.getBounds().getCenter();
      const li=document.createElement("li");
      li.innerHTML=`#${i+1} Lat:${center.lat.toFixed(5)} Lng:${center.lng.toFixed(5)} <span class="pill">${(b.conf*100).toFixed(1)}%</span>`;
      mapList.appendChild(li);
    });
    mapCount.textContent="Elephants detected: "+boxes.length;
    mapStatus.textContent="Done"; mapBar.style.width="100%";
    analyzeMap.disabled=false; setTimeout(()=>mapBar.style.width="0%",800);
  });
}
analyzeMap.onclick=detectMapView;
</script>
</body>
</html>
